"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8339],{58339:function(e,t,r){r.d(t,{Z:function(){return D}});var i=r(85893),a=r(67294),n=r(9729),o=r(31754),s=r(21485),l=r(84677),c=r(97182),d=r(52857),u=r(26541),p=r(49555),h=r(97254),f=r(11370),m=r(83218),x=r(67642),g=r(25675),y=r.n(g),w=r(75854),v=r(22078),j=r(4642),b=r(87786),S=r(18524),Z=r(76184),C=r(44725);function k(e){let{peerConnection:t,localStream:r,remoteStream:o,isVideo:s,onEndCall:l,onToggleVideo:c,onToggleAudio:u}=e,p=(0,a.useRef)(null),h=(0,a.useRef)(null),[m,x]=(0,a.useState)(s),[g,y]=(0,a.useState)(!0);return(0,a.useEffect)(()=>{p.current&&r&&(p.current.srcObject=r,console.log("localStream",r))},[r,o]),(0,a.useEffect)(()=>{h.current&&o&&(console.log("remoteStream",o),h.current.srcObject=o)},[o]),(0,i.jsxs)(n.Z,{sx:{width:"100%",height:"100%",position:"relative"},children:[(0,i.jsxs)(n.Z,{sx:{display:"flex",height:"100%"},children:[o&&(0,i.jsx)("video",{ref:h,autoPlay:!0,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"cover"}}),r&&(0,i.jsx)("video",{ref:p,autoPlay:!0,playsInline:!0,muted:!0,style:{position:"absolute",width:"150px",height:"150px",bottom:80,right:20,objectFit:"cover",borderRadius:"8px"}})]}),(0,i.jsxs)(n.Z,{sx:{position:"absolute",bottom:20,left:"50%",transform:"translateX(-50%)",display:"flex",gap:2,backgroundColor:"rgba(0,0,0,0.5)",padding:2,borderRadius:4},children:[(0,i.jsx)(d.Z,{onClick:()=>{x(!m),c()},color:"primary",children:m?(0,i.jsx)(b.Z,{}):(0,i.jsx)(S.Z,{})}),(0,i.jsx)(d.Z,{onClick:()=>{y(!g),u()},color:"primary",children:g?(0,i.jsx)(f.Z,{}):(0,i.jsx)(Z.Z,{})}),(0,i.jsx)(d.Z,{onClick:l,color:"error",children:(0,i.jsx)(C.Z,{})})]})]})}class E{async initPeer(){this.peer||(this.peer=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]}))}async getAnswer(e){if(this.peer)try{await this.peer.setRemoteDescription(new RTCSessionDescription(e));let t=await this.peer.createAnswer();return await this.peer.setLocalDescription(t),t}catch(e){throw console.error("Error creating answer:",e),e}}async setLocalDescription(e){if(this.peer)try{("stable"===this.peer.signalingState||"have-local-offer"===this.peer.signalingState)&&await this.peer.setRemoteDescription(new RTCSessionDescription(e))}catch(e){throw console.error("Error setting remote description:",e),e}}async getOffer(){if(this.peer){let e=await this.peer.createOffer();return await this.peer.setLocalDescription(new RTCSessionDescription(e)),e}}constructor(){this.peer=null}}let T=new E;function D(e){let{currentUser:t,receiver:r}=e,[g,S]=(0,a.useState)([]),[Z,C]=(0,a.useState)(""),[E,D]=(0,a.useState)(!0),[R,I]=(0,a.useState)([]),[_,U]=(0,a.useState)(!1),[M,P]=(0,a.useState)(0),[N,z]=(0,a.useState)(null),O=(0,a.useRef)(null),W=(0,a.useRef)(null),A=(0,a.useRef)(null),L=(0,a.useRef)(null),F=[t._id,r._id].sort().join("-"),B=function(){let[e,t]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{(async()=>{await T.initPeer(),t(!0)})()},[]),e?T:null}();(0,a.useEffect)(()=>(L.current=(0,x.io)("http://localhost:3000"),L.current.emit("join",F),L.current.on("message",e=>{S(t=>[...t,e])}),L.current.on("call-offer",er),L.current.on("call-answer",ei),L.current.on("ice-candidate",ea),()=>{L.current.emit("leave",F),L.current.disconnect()}),[F,B]),(0,a.useEffect)(()=>{q()},[t._id,r._id]),(0,a.useEffect)(()=>{V()},[g]);let V=()=>{var e;null===(e=W.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},q=async()=>{try{D(!0);let e=await fetch("/api/chat?sender=".concat(t._id,"&receiver=").concat(r._id));if(e.ok){let t=await e.json();S(t.data)}}catch(e){console.error("Error fetching messages:",e)}finally{D(!1)}},G=async()=>{let e=null;try{if(navigator.mediaDevices){let t=await navigator.permissions.query({name:"microphone"});if("denied"===t.state){alert("Please allow microphone access in your browser settings to use this feature.");return}await navigator.mediaDevices.enumerateDevices();let r=localStorage.getItem("preferredMicrophoneId");e=await navigator.mediaDevices.getUserMedia({audio:{deviceId:r?{exact:r}:void 0,echoCancellation:!0,noiseSuppression:!0,sampleRate:44100}});let i=new MediaRecorder(e,{mimeType:"audio/webm"}),a=[];i.ondataavailable=e=>{a.push(e.data)},i.onstop=()=>{let e=new Blob(a,{type:"audio/webm"}),t=new File([e],"voice-message.webm",{type:"audio/webm"});I([t])},i.start(),z(i),U(!0),P(0),A.current=setInterval(()=>{P(e=>e+1)},1e3)}}catch(t){console.error("Error starting recording:",t),e&&e.getTracks().forEach(e=>e.stop()),U(!1),A.current&&clearInterval(A.current),alert("Unable to access microphone. Please check your browser settings.")}},H=()=>{N&&(N.stop(),U(!1),A.current&&clearInterval(A.current))},J=async e=>{if(e.preventDefault(),Z.trim()||R)try{let e=new FormData;e.append("sender",t._id),e.append("receiver",r._id),e.append("roomId",[t._id,r._id].sort().join("-")),Z.trim()&&e.append("content",Z),R&&R.forEach(t=>{e.append("files",t)});let i=await fetch("/api/chat",{method:"POST",body:e});if(i.ok){let e=await i.json();L.current.emit("message",e.data),C(""),I([]),O.current&&(O.current.value="")}}catch(e){console.error("Error sending message:",e)}},[X,Y]=(0,a.useState)(null),[K,Q]=(0,a.useState)(null),[$,ee]=(0,a.useState)(!1),et=async e=>{try{let i=await navigator.mediaDevices.getUserMedia({audio:!1,video:e});for(let e of(Y(i),i.getTracks()))B.peer.addTrack(e,i);B.peer.onicecandidate=e=>{e.candidate&&L.current.emit("ice-candidate",{candidate:e.candidate,to:r._id,from:t._id,roomId:F})};let a=await B.getOffer();L.current.emit("call-offer",{offer:a,to:r._id,from:t._id,roomId:F}),ee(!0)}catch(e){console.error("Error starting call:",e),alert("Failed to start call. Please check your camera/microphone permissions.")}},er=async e=>{try{let r=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});Y(r),r.getTracks().forEach(e=>{B.peer.addTrack(e,r)}),B.peer.onicecandidate=r=>{r.candidate&&L.current.emit("ice-candidate",{candidate:r.candidate,to:e.from,from:t._id,roomId:F})},await B.peer.setRemoteDescription(new RTCSessionDescription(e.offer));let i=await B.peer.createAnswer();await B.peer.setLocalDescription(i),L.current.emit("call-answer",{answer:i,to:e.from,from:t._id,roomId:F}),ee(!0)}catch(e){console.error("Error handling call offer:",e)}};(0,a.useEffect)(()=>{B&&(B.peer.ontrack=e=>{console.log("event",e),Q(e.streams[0])})},[B]);let ei=async e=>{let{from:t,answer:r}=e;try{console.log("Received answer:",r),B&&"have-local-offer"===B.peer.signalingState&&await B.peer.setRemoteDescription(new RTCSessionDescription(r))}catch(e){console.error("Error handling call answer:",e)}},ea=async e=>{try{B.peer&&await B.peer.addIceCandidate(new RTCIceCandidate(e.candidate))}catch(e){console.error("Error handling ICE candidate:",e)}};return E?(0,i.jsx)(n.Z,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:(0,i.jsx)(c.Z,{})}):(0,i.jsxs)(n.Z,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[$&&(0,i.jsx)(n.Z,{sx:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e3},children:(0,i.jsx)(k,{peerConnection:B.peer,localStream:X,remoteStream:K,isVideo:!0,onEndCall:()=>{X&&(console.log("close"),X.getTracks().forEach(e=>e.stop()),Y(null)),B.peer&&B.peer.close(),Q(null),ee(!1)},onToggleVideo:()=>{if(X){let e=X.getVideoTracks()[0];e&&(e.enabled=!e.enabled)}},onToggleAudio:()=>{if(X){let e=X.getAudioTracks()[0];e&&(e.enabled=!e.enabled)}}})}),(0,i.jsx)(n.Z,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:(0,i.jsx)(s.Z,{variant:"h6",children:r.name})}),(0,i.jsxs)(n.Z,{sx:{flexGrow:1,overflow:"auto",p:2},children:[g.map(e=>{var r,a;let c=e.sender===t._id;return(0,i.jsx)(n.Z,{sx:{display:"flex",justifyContent:c?"flex-end":"flex-start",mb:2},children:(0,i.jsxs)(o.Z,{sx:{p:2,maxWidth:"70%",bgcolor:c?"primary.main":"grey.100",color:c?"white":"text.primary"},children:[e.content&&(0,i.jsx)(s.Z,{sx:{mb:e.fileUrl?1:0},children:e.content}),(null==e?void 0:e.media)&&e.media.length>0?(0,i.jsx)("div",{className:"d-flex flex-wrap mt-2",children:e.media.map(e=>e.fileType.includes("audio")?(0,i.jsx)("audio",{src:e.fileUrl,controls:!0}):e.fileType.includes("image")?(0,i.jsx)(y(),{alt:e.fileName,src:e.fileUrl,width:200,height:100,className:"me-2 mb-2"}):e.fileType.includes("video")?(0,i.jsx)("video",{src:e.fileUrl,controls:!0,style:{width:"300px",height:"200px"}}):null)}):null,e.fileUrl&&(0,i.jsx)(n.Z,{children:(null===(r=e.fileType)||void 0===r?void 0:r.startsWith("audio/"))?(0,i.jsxs)("audio",{controls:!0,style:{maxWidth:"200px"},children:[(0,i.jsx)("source",{src:"/".concat(e.fileUrl),type:e.fileType}),"Your browser does not support the audio element."]}):(null===(a=e.fileType)||void 0===a?void 0:a.startsWith("image/"))?(0,i.jsx)("img",{src:"/".concat(e.fileUrl),alt:e.fileName,style:{maxWidth:"200px",maxHeight:"200px",borderRadius:"8px",marginTop:"8px"}}):(0,i.jsxs)(l.Z,{href:"/".concat(e.fileUrl),target:"_blank",variant:"contained",size:"small",sx:{mt:1},children:["Download ",e.fileName]})})]})},e._id)}),(0,i.jsx)("div",{ref:W})]}),(0,i.jsxs)(n.Z,{component:"form",onSubmit:J,sx:{p:2,borderTop:1,borderColor:"divider"},children:[(0,i.jsxs)(n.Z,{sx:{display:"flex",gap:1,alignItems:"center"},children:[(0,i.jsx)("input",{type:"file",ref:O,onChange:e=>{e.target.files&&e.target.files.length>0&&I(Array.from(e.target.files))},multiple:!0,style:{display:"none"}}),(0,i.jsx)(d.Z,{onClick:()=>{var e;return null===(e=O.current)||void 0===e?void 0:e.click()},size:"small",children:(0,i.jsx)(h.Z,{})}),(0,i.jsx)(d.Z,{size:"small",onClick:v.W2,children:(0,i.jsx)(w.Z,{})}),(0,i.jsx)(d.Z,{size:"small",onClick:()=>et(!1),children:(0,i.jsx)(j.Z,{})}),(0,i.jsx)(d.Z,{size:"small",onClick:()=>et(!0),children:(0,i.jsx)(b.Z,{})}),(0,i.jsx)(d.Z,{onClick:()=>_?H():G(),size:"small",className:"ps-0",color:_?"error":"default",children:_?(0,i.jsx)(m.Z,{}):(0,i.jsx)(f.Z,{})}),_&&(0,i.jsx)(s.Z,{variant:"caption",color:"error",children:"".concat(Math.floor(M/60),":").concat((M%60).toString().padStart(2,"0"))}),(0,i.jsx)(u.Z,{fullWidth:!0,size:"small",value:Z,onChange:e=>C(e.target.value),placeholder:"Type a message..."}),(0,i.jsx)(l.Z,{type:"submit",disabled:!Z&&0===R.length,variant:"contained",endIcon:(0,i.jsx)(p.Z,{}),children:"Send"})]}),R&&R.length>0&&(0,i.jsxs)(s.Z,{variant:"caption",sx:{ml:1,mt:1},children:["Selected file: ",R.map(e=>e.name+" ")]})]})]})}},22078:function(e,t,r){r.d(t,{Gm:function(){return l},I9:function(){return c},Sk:function(){return o},W2:function(){return n},bJ:function(){return s},iO:function(){return d}});var i=r(30381),a=r.n(i);let n=async()=>{try{let e=await navigator.permissions.query({name:"microphone"});if("denied"===e.state){alert("Please allow microphone access in your browser settings to use this feature.");return}let t=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind),r=document.createElement("dialog");r.style.padding="20px",r.style.borderRadius="8px",r.style.boxShadow="0 2px 10px rgba(0,0,0,0.1)";let i=document.createElement("button");i.innerHTML="âœ•",i.style.position="absolute",i.style.right="10px",i.style.top="10px",i.style.border="none",i.style.background="none",i.style.fontSize="20px",i.style.cursor="pointer",i.onclick=()=>r.close(),r.appendChild(i);let a=document.createElement("h3");a.textContent="Select Audio Device",r.appendChild(a);let n=document.createElement("select");n.style.width="100%",n.style.padding="8px",n.style.marginBottom="10px",t.forEach(e=>{let t=document.createElement("option");t.value=e.deviceId,t.text=e.label||"Microphone ".concat(e.deviceId.slice(0,5)),n.appendChild(t)});let o=document.createElement("button");o.textContent="Save Selection",o.style.padding="8px 16px",o.onclick=()=>{localStorage.setItem("preferredMicrophoneId",n.value),r.close()},r.appendChild(n),r.appendChild(o),document.body.appendChild(r),r.showModal()}catch(e){console.error("Error accessing media devices:",e),alert("Unable to access microphone. Please check your browser settings.")}},o=e=>{let t=new Blob([e],{type:e.type});return URL.createObjectURL(t)},s=(e,t)=>e.reduce((e,r)=>e+parseInt(r[t]),0),l=e=>{let t="00",r="00",i="00";if(e){let a=Math.floor(e.asSeconds());t=Math.floor(a/3600).toString().padStart(2,"0"),r=Math.floor(a%3600/60).toString().padStart(2,"0"),i=Math.floor(a%60).toString().padStart(2,"0")}return"".concat(t,":").concat(r,":").concat(i)},c=(e,t)=>{let[r,i]=t.split(":"),n=a()(e).add(Number(r),"hours").add(Number(i),"minutes"),o=a()(),s=a().duration(n.diff(o));return 0>s.asSeconds()&&(s=a().duration(0)),console.log("Current time:",n.format()),s},d=e=>1===e?"1st":2===e?"2nd":3===e?"3rd":"".concat(e,"th")}}]);