"use strict";(()=>{var e={};e.id=8170,e.ids=[8170],e.modules={11185:e=>{e.exports=require("mongoose")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},55315:e=>{e.exports=require("path")},36705:e=>{e.exports=import("formidable")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},44753:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>c,routeModule:()=>l});var a=r(71802),i=r(47153),s=r(56249),o=r(69751),d=e([o]);o=(d.then?(await d)():d)[0];let c=(0,s.l)(o,"default"),u=(0,s.l)(o,"config"),l=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/chat",pathname:"/api/chat",bundlePath:"",filename:""},userland:o});n()}catch(e){n(e)}})},39352:(e,t,r)=>{r.d(t,{Z:()=>o});var n=r(11185),a=r.n(n);let i="mongodb+srv://nolantapps:oCOt2NNcEQKUZcuj@impacto-cluster.s20zbjj.mongodb.net/axiom?retryWrites=true&w=majority";if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let o=async function(){if(s.conn)return s.conn;s.promise||(s.promise=a().connect(i,{bufferCommands:!0}));try{return s.conn=await s.promise,console.log("MongoDB Connected Successfully"),s.conn}catch(e){throw s.promise=null,console.error("MongoDB Connection Error:",e),e}}},18606:(e,t,r)=>{r.d(t,{Q:()=>a});let n=require("next-auth/jwt");function a(e){return async(t,r)=>{let a=await (0,n.getToken)({req:t,secret:process.env.JWT_SECRET});return a?(t.user=a,e(t,r)):r.status(401).json({success:!1,message:"Not authenticated"})}}},71324:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(11185),a=r.n(n);let i=new(a()).Schema({sender:{type:a().Schema.Types.ObjectId,ref:"User",required:!0},receiver:{type:a().Schema.Types.ObjectId,ref:"User",required:!0},content:{type:String,required:!1},roomId:{type:String,required:!0},read:{type:Boolean,default:!1},media:[{fileUrl:{type:String},fileName:{type:String},fileType:{type:String}}]},{timestamps:!0}),s=a().models.Chat||a().model("Chat",i)},90435:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(11185),a=r.n(n);let i=new(a()).Schema({recipient:{type:a().Schema.Types.ObjectId,ref:"User",required:!0},type:{type:String,enum:["friend_request","tournament","announcement","reminder","message"],required:!0},title:{type:String,required:!0},description:String,isRead:{type:Boolean,default:!1},status:{type:String,enum:["pending","accepted","rejected"],default:"pending"},relatedId:{type:a().Schema.Types.ObjectId,required:!0},createdAt:{type:Date,default:Date.now}}),s=a().models.Notification||a().model("Notification",i)},55895:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(11185),a=r.n(n);let i=new(a()).Schema({userId:{type:a().Schema.Types.ObjectId,ref:"User",required:!0},module:{type:String,required:!0},type:{type:String,required:!0},enabled:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),s=a().models.Settings||a().model("Settings",i)},70971:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(11185),a=r.n(n);let i=new(a()).Schema({name:{type:String,required:!0},walletBalance:{type:Number,default:0},stripeConnectId:{type:String,default:null},stripeAccountStatus:{type:String,enum:["pending","active","rejected","restricted"],default:"pending"},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},role:{type:String,enum:["Admin","User","Agent","Super"],default:"User"},cName:String,profileImage:{type:String,required:!1},friends:[{type:a().Schema.Types.ObjectId,ref:"User"}],createdAt:{type:Date,default:Date.now}}),s=a().models.User||a().model("User",i)},69751:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>y,default:()=>f});var a=r(39352),i=r(71324),s=r(36705),o=r(55315),d=r.n(o),c=r(55895),u=r(90435),l=r(70971),p=r(18606),m=e([s]);s=(m.then?(await m)():m)[0];let y={api:{bodyParser:!1}},f=(0,p.Q)(async function(e,t){if(await (0,a.Z)(),"GET"===e.method)try{let{sender:r,receiver:n}=e.query,a=await i.Z.find({$or:[{sender:r,receiver:n},{sender:n,receiver:r}]}).sort({createdAt:1});t.status(200).json({success:!0,data:a})}catch(e){t.status(500).json({success:!1,message:e.message})}else if("POST"===e.method)try{let r=(0,s.default)({uploadDir:d().join(process.cwd(),"public/uploads"),keepExtensions:!0}),[n,a]=await new Promise((t,n)=>{r.parse(e,(e,r,a)=>{e&&n(e),t([r,a])})}),o={sender:Array.isArray(n.sender)?n.sender[0]:n.sender,receiver:Array.isArray(n.receiver)?n.receiver[0]:n.receiver,roomId:Array.isArray(n.roomId)?n.roomId[0]:n.roomId,content:Array.isArray(n.content)?n.content[0]:n.content||"",media:[]};a.files&&a.files.length>0&&a.files.map(e=>{let t=e.originalFilename||e.newFilename,r=`/uploads/${d().basename(e.filepath)}`;o.media.push({fileName:t,fileUrl:r,fileType:e.mimetype})});let p=await i.Z.create(o),m=await c.Z.findOne({type:"message",enabled:!0,userId:o.receiver}),y=await l.Z.findById(o.receiver);m&&"User"===y.role?await u.Z.create({recipient:m.userId,type:"message",title:`${e.user.name} sent you a message`,relatedId:p._id,status:"accepted"}):y&&"User"!==y.role&&await u.Z.create({recipient:y._id,type:"message",title:`${e.user.name} sent you a message`,relatedId:p._id,status:"accepted"});let f=await p;t.status(201).json({success:!0,data:f})}catch(e){t.status(500).json({success:!1,message:e.message})}else t.status(405).json({success:!1,message:"Method not allowed"})});n()}catch(e){n(e)}})},47153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=44753);module.exports=r})();